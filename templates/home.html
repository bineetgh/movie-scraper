{% extends "base.html" %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Watchlazy",
    "url": "{{ base_url }}",
    "description": "{{ page_description }}",
    "potentialAction": {
        "@type": "SearchAction",
        "target": "{{ base_url }}/search?q={search_term_string}",
        "query-input": "required name=search_term_string"
    }
}
</script>
{% endblock %}

{% block content %}
<!-- Free Movies Section (SSR - loads immediately) -->
<section class="genre-section" id="freeMoviesSection">
    <div class="genre-section-header">
        <h2>Free Movies to Watch Right Now</h2>
        <a href="/free-movies">See All</a>
    </div>
    <div class="movies-row">
        {% for movie in free_movies %}
        {% include "components/movie_card.html" %}
        {% endfor %}
    </div>
</section>

<!-- Top Rated Section (SSR - loads immediately) -->
<section class="genre-section" id="topRatedSection">
    <div class="genre-section-header">
        <h2>Top Rated</h2>
        <a href="/top-rated">See All</a>
    </div>
    <div class="movies-row">
        {% for movie in top_rated_movies %}
        {% include "components/movie_card.html" %}
        {% endfor %}
    </div>
</section>

<!-- For Me Section (personalized - client side) -->
<section class="genre-section" id="forMeSection" style="display: none;">
    <div class="genre-section-header">
        <h2>For You</h2>
        <a href="/for-me">See All</a>
    </div>
    <div class="movies-row" id="forMeMovies"></div>
</section>

<!-- Lazy loaded sections container -->
<div id="lazySectionsContainer">
    <!-- Skeleton placeholders for curated collections -->
    {% for clist in curated_lists %}
    <section class="genre-section skeleton-section" data-section="collection-{{ clist.slug }}">
        <div class="genre-section-header">
            <h2>{{ clist.label }}</h2>
            <a href="/list/{{ clist.slug }}">See All</a>
        </div>
        <div class="movies-row skeleton-row">
            {% for i in range(6) %}
            <div class="movie-card skeleton">
                <div class="skeleton-poster"></div>
                <div class="skeleton-info">
                    <div class="skeleton-title"></div>
                    <div class="skeleton-meta"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endfor %}

    <!-- Recently Added skeleton -->
    <section class="genre-section skeleton-section" data-section="recent">
        <div class="genre-section-header">
            <h2>Recently Added</h2>
            <a href="/browse">Browse All</a>
        </div>
        <div class="movies-row skeleton-row">
            {% for i in range(6) %}
            <div class="movie-card skeleton">
                <div class="skeleton-poster"></div>
                <div class="skeleton-info">
                    <div class="skeleton-title"></div>
                    <div class="skeleton-meta"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
</div>

{% if not free_movies and not top_rated_movies %}
<div class="no-results">
    <div class="no-results-icon">ðŸŽ¬</div>
    <h3>No movies available</h3>
    <p>Check back soon for new content!</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    // ========== Movie Card Creation ==========
    function createMovieCard(movie) {
        const article = document.createElement('article');
        article.className = 'movie-card';
        article.dataset.movieSlug = movie.slug;
        article.dataset.genres = (movie.genres || []).join(',');

        let posterHtml = movie.poster_url
            ? `<img src="${movie.poster_url}" alt="${movie.title} poster" loading="lazy" class="movie-poster">`
            : `<div class="movie-poster" style="display:flex;align-items:center;justify-content:center;font-size:3rem;color:var(--text-muted);">ðŸŽ¬</div>`;

        let badgeHtml = '';
        if (movie.is_free) {
            badgeHtml = '<span class="availability-badge free">Free</span>';
        }

        article.innerHTML = `
            <a href="/movie/${movie.slug}">
                <div class="poster-container">
                    ${posterHtml}
                    ${badgeHtml}
                </div>
                <div class="movie-info">
                    <h3 class="movie-title">${movie.title}</h3>
                    <div class="movie-meta">
                        ${movie.year ? `<span>${movie.year}</span>` : ''}
                        ${movie.rating ? `<span class="movie-rating">${movie.rating} IMDb</span>` : ''}
                    </div>
                </div>
            </a>
        `;
        return article;
    }

    // ========== Batch Load All Sections ==========
    let allMoviesData = null;

    async function loadAllSections() {
        try {
            const response = await fetch('/api/home/sections/all');
            const data = await response.json();

            // Store for-me data
            allMoviesData = data.for_me_movies || [];

            // Populate each section
            data.sections.forEach(section => {
                const sectionEl = document.querySelector(`[data-section="${section.name}"]`);
                if (sectionEl && section.movies.length > 0) {
                    const row = sectionEl.querySelector('.movies-row');
                    row.innerHTML = '';
                    row.classList.remove('skeleton-row');
                    section.movies.forEach(movie => {
                        row.appendChild(createMovieCard(movie));
                    });
                    sectionEl.classList.remove('skeleton-section');
                } else if (sectionEl) {
                    // Hide empty sections
                    sectionEl.style.display = 'none';
                }
            });

            // Initialize For Me section after data is loaded
            initForMeSection();

        } catch (e) {
            console.error('Failed to load sections:', e);
        }
    }

    // ========== For Me Section ==========
    function initForMeSection() {
        const section = document.getElementById('forMeSection');
        const container = document.getElementById('forMeMovies');
        if (!section || !container || !allMoviesData) return;

        const WATCHED_KEY = 'watchlazyWatched';
        const REACTIONS_KEY = 'watchlazyReactions';

        const watched = JSON.parse(localStorage.getItem(WATCHED_KEY) || '{}');
        const reactions = JSON.parse(localStorage.getItem(REACTIONS_KEY) || '{}');

        const hasPreferences = Object.keys(reactions).length > 0 || Object.keys(watched).length > 0;
        if (!hasPreferences) return;

        // Calculate genre scores
        const genreScores = {};
        const watchedSlugs = {};

        Object.keys(watched).forEach(slug => {
            watchedSlugs[slug] = true;
            (watched[slug].genres || []).forEach(genre => {
                genreScores[genre] = (genreScores[genre] || 0) + 1;
            });
        });

        Object.keys(reactions).forEach(slug => {
            const data = reactions[slug];
            const weight = data.reaction === 'loved' ? 3 : (data.reaction === 'liked' ? 2 : -1);
            (data.genres || []).forEach(genre => {
                genreScores[genre] = (genreScores[genre] || 0) + weight;
            });
        });

        // Score and filter movies
        const scoredMovies = allMoviesData
            .filter(m => !watchedSlugs[m.slug])
            .map(m => {
                let score = 0;
                (m.genres || []).forEach(g => {
                    score += (genreScores[g] || 0) * 10;
                });
                if (m.rating) score += m.rating * 2;
                m.recScore = score;
                return m;
            })
            .filter(m => m.recScore > 0)
            .sort((a, b) => b.recScore - a.recScore)
            .slice(0, 12);

        if (scoredMovies.length === 0) return;

        // Show section and populate
        section.style.display = 'block';
        scoredMovies.forEach(movie => {
            container.appendChild(createMovieCard(movie));
        });
    }

    // ========== Initialize ==========
    // Load all sections after initial render
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadAllSections, 100);
        });
    } else {
        setTimeout(loadAllSections, 100);
    }

})();
</script>
{% endblock %}
