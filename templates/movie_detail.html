{% extends "base.html" %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Movie",
    "name": {{ movie.title | tojson }},
    "description": {{ (movie.synopsis if movie.synopsis else 'Watch ' + movie.title + ' for free on streaming platforms.') | tojson }},
    {% if movie.year %}
    "datePublished": "{{ movie.year }}",
    {% endif %}
    {% if movie.director %}
    "director": {
        "@type": "Person",
        "name": {{ movie.director | tojson }}
    },
    {% endif %}
    {% if movie.cast %}
    "actor": [
        {% for actor in movie.cast[:5] %}
        {
            "@type": "Person",
            "name": {{ actor | tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    {% endif %}
    {% if movie.genres %}
    "genre": {{ movie.genres | tojson }},
    {% endif %}
    {% if movie.rating %}
    "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "{{ movie.rating }}",
        "bestRating": "10",
        "worstRating": "1",
        "ratingCount": "1000"
    },
    {% endif %}
    {% if movie.runtime_minutes %}
    "duration": "PT{{ movie.runtime_minutes }}M",
    {% endif %}
    {% if movie.poster_url %}
    "image": {{ movie.poster_url | tojson }},
    {% endif %}
    "url": {{ (base_url + movie.canonical_url) | tojson }}
}
</script>

<!-- BreadcrumbList structured data -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "{{ base_url }}/"
        },
        {
            "@type": "ListItem",
            "position": 2,
            "name": "Movies",
            "item": "{{ base_url }}/browse"
        },
        {
            "@type": "ListItem",
            "position": 3,
            "name": "{{ movie.title }}",
            "item": "{{ base_url }}{{ movie.canonical_url }}"
        }
    ]
}
</script>
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="Breadcrumb" class="breadcrumb">
    <ol>
        <li><a href="/">Home</a></li>
        <li><a href="/browse">Movies</a></li>
        <li><span>{{ movie.title }}</span></li>
    </ol>
</nav>

<article class="movie-detail">
    <div class="movie-detail-hero"{% if movie.backdrop_url %} style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url('{{ movie.backdrop_url }}'); background-size: cover; background-position: center;"{% endif %}>
        {% if movie.best_poster_url or movie.poster_url %}
        <img src="{{ movie.best_poster_url or movie.poster_url }}"
             alt="{{ movie.title }} poster"
             class="movie-poster-large"
             loading="eager">
        {% endif %}

        <div class="movie-detail-info">
            <h1>{{ movie.title }}{% if movie.year %} ({{ movie.year }}){% endif %}</h1>

            <div class="movie-meta">
                {% if movie.year %}<span>{{ movie.year }}</span>{% endif %}
                {% if movie.runtime_minutes %}<span>{{ movie.runtime_minutes }} min</span>{% endif %}
                {% if movie.rating %}<span class="rating">IMDb {{ movie.rating }}</span>{% endif %}
            </div>

            <div class="movie-genres">
                {% for genre in movie.genres %}
                <a href="/browse?genre={{ genre | urlencode }}" class="genre-tag">{{ genre }}</a>
                {% endfor %}
            </div>

            {% if movie.director %}
            <p class="director">Directed by <strong>{{ movie.director }}</strong></p>
            {% endif %}

            {% if movie.synopsis %}
            <p class="synopsis">{{ movie.synopsis }}</p>
            {% endif %}

            {% if movie.cast %}
            <div class="cast">
                <h3>Cast</h3>
                <p>{{ movie.cast | join(', ') }}</p>
            </div>
            {% endif %}

            <!-- Streaming Availability -->
            <div class="streaming-availability">
                <h3>Where to Watch</h3>

                {% if movie.streaming.unique_free_offers %}
                <div class="offer-section offer-free">
                    <h4>Watch Free</h4>
                    <div class="offer-buttons">
                        {% for offer in movie.streaming.unique_free_offers %}
                        <a href="{{ offer.url }}" target="_blank" rel="noopener" class="offer-btn offer-btn-free">
                            <span class="provider">{{ offer.provider_name }}</span>
                            <span class="type">{{ 'With Ads' if offer.monetization_type == 'ADS' else 'Free' }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if movie.streaming.unique_subscription_offers %}
                <div class="offer-section offer-subscription">
                    <h4>Subscription</h4>
                    <div class="offer-buttons">
                        {% for offer in movie.streaming.unique_subscription_offers %}
                        <a href="{{ offer.url }}" target="_blank" rel="noopener" class="offer-btn offer-btn-sub">
                            <span class="provider">{{ offer.provider_name }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if movie.streaming.unique_rent_offers %}
                <div class="offer-section offer-rent">
                    <h4>Rent</h4>
                    <div class="offer-buttons">
                        {% for offer in movie.streaming.unique_rent_offers %}
                        <a href="{{ offer.url }}" target="_blank" rel="noopener" class="offer-btn offer-btn-rent">
                            <span class="provider">{{ offer.provider_name }}</span>
                            {% if offer.price %}
                            <span class="price">Rs.{{ offer.price | int }}{% if offer.presentation_type %} {{ offer.presentation_type }}{% endif %}</span>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if movie.streaming.unique_buy_offers %}
                <div class="offer-section offer-buy">
                    <h4>Buy</h4>
                    <div class="offer-buttons">
                        {% for offer in movie.streaming.unique_buy_offers %}
                        <a href="{{ offer.url }}" target="_blank" rel="noopener" class="offer-btn offer-btn-buy">
                            <span class="provider">{{ offer.provider_name }}</span>
                            {% if offer.price %}
                            <span class="price">Rs.{{ offer.price | int }}{% if offer.presentation_type %} {{ offer.presentation_type }}{% endif %}</span>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if not movie.streaming.unique_free_offers and not movie.streaming.unique_subscription_offers and not movie.streaming.unique_rent_offers and not movie.streaming.unique_buy_offers %}
                {% if movie.source_urls %}
                <div class="offer-section">
                    <div class="offer-buttons">
                        {% for url in movie.source_urls %}
                        <a href="{{ url }}" target="_blank" rel="noopener" class="offer-btn">
                            {% if 'archive.org' in url %}Internet Archive{% else %}Watch Now{% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Related Movies -->
    {% if related_movies %}
    <section class="related-movies">
        <h2>You Might Also Like</h2>
        <div class="movies-grid">
            {% for movie in related_movies %}
            {% include "components/movie_card.html" %}
            {% endfor %}
        </div>
    </section>
    {% endif %}
</article>
{% endblock %}
