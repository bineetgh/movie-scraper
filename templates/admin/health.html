{% extends "admin/base.html" %}

{% block title %}System Health - Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1>System Health</h1>
    <p>Monitor system status and performance</p>
</div>

<!-- Status Cards -->
<div class="health-grid">
    <!-- MongoDB Status -->
    <div class="health-card {{ 'healthy' if health.mongodb.connected else 'unhealthy' }}">
        <div class="health-header">
            <span class="health-icon">{{ '&#10003;' if health.mongodb.connected else '&#10007;' }}</span>
            <h3>MongoDB</h3>
        </div>
        <div class="health-details">
            <div class="health-row">
                <span>Status</span>
                <span class="status-badge {{ 'success' if health.mongodb.connected else 'error' }}">
                    {{ 'Connected' if health.mongodb.connected else 'Disconnected' }}
                </span>
            </div>
            {% if health.mongodb.connected %}
            <div class="health-row">
                <span>Movies</span>
                <span>{{ health.mongodb.movies_count | default(0) }}</span>
            </div>
            <div class="health-row">
                <span>TV Shows</span>
                <span>{{ health.mongodb.tvshows_count | default(0) }}</span>
            </div>
            <div class="health-row">
                <span>Curated Lists</span>
                <span>{{ health.mongodb.lists_count | default(0) }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Cache Status -->
    <div class="health-card {{ 'healthy' if health.cache.available else 'unhealthy' }}">
        <div class="health-header">
            <span class="health-icon">{{ '&#10003;' if health.cache.available else '&#10007;' }}</span>
            <h3>Cache</h3>
        </div>
        <div class="health-details">
            <div class="health-row">
                <span>Backend</span>
                <span>{{ health.cache.backend | default('Unknown') }}</span>
            </div>
            <div class="health-row">
                <span>Status</span>
                <span class="status-badge {{ 'success' if health.cache.available else 'warning' }}">
                    {{ 'Available' if health.cache.available else 'Fallback Mode' }}
                </span>
            </div>
            <div class="health-row">
                <span>File Cache</span>
                <span>{{ health.cache.file_movies | default(0) }} movies</span>
            </div>
        </div>
    </div>

    <!-- Scheduler Status -->
    <div class="health-card {{ 'healthy' if health.scheduler.running else 'neutral' }}">
        <div class="health-header">
            <span class="health-icon">{{ '&#10003;' if health.scheduler.running else '&#8212;' }}</span>
            <h3>Scheduler</h3>
        </div>
        <div class="health-details">
            <div class="health-row">
                <span>Status</span>
                <span class="status-badge {{ 'success' if health.scheduler.running else 'neutral' }}">
                    {{ 'Running' if health.scheduler.running else 'Disabled' }}
                </span>
            </div>
            {% if health.scheduler.running %}
            <div class="health-row">
                <span>Interval</span>
                <span>{{ health.scheduler.interval_hours }} hours</span>
            </div>
            <div class="health-row">
                <span>Runs</span>
                <span>{{ health.scheduler.runs_count | default(0) }}</span>
            </div>
            <div class="health-row">
                <span>Movies Added</span>
                <span>{{ health.scheduler.total_added | default(0) }}</span>
            </div>
            {% if health.scheduler.last_run %}
            <div class="health-row">
                <span>Last Run</span>
                <span>{{ health.scheduler.last_run }}</span>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- API Status -->
    <div class="health-card healthy">
        <div class="health-header">
            <span class="health-icon">&#10003;</span>
            <h3>API</h3>
        </div>
        <div class="health-details">
            <div class="health-row">
                <span>Status</span>
                <span class="status-badge success">Running</span>
            </div>
            <div class="health-row">
                <span>Rate Limiting</span>
                <span class="status-badge success">Active</span>
            </div>
            <div class="health-row">
                <span>Endpoints</span>
                <span>{{ health.api.endpoints_count | default('50+') }}</span>
            </div>
        </div>
    </div>
</div>

<!-- External APIs -->
<div class="section-header">
    <h2>External APIs</h2>
</div>

<div class="health-grid">
    <!-- JustWatch -->
    <div class="health-card {{ 'healthy' if health.external.justwatch else 'unhealthy' }}">
        <div class="health-header">
            <span class="health-icon">{{ '&#10003;' if health.external.justwatch else '&#10007;' }}</span>
            <h3>JustWatch API</h3>
        </div>
        <div class="health-details">
            <div class="health-row">
                <span>Status</span>
                <span class="status-badge {{ 'success' if health.external.justwatch else 'error' }}">
                    {{ 'Reachable' if health.external.justwatch else 'Unreachable' }}
                </span>
            </div>
        </div>
    </div>

    <!-- TMDB -->
    <div class="health-card {{ 'healthy' if health.external.tmdb else 'neutral' }}">
        <div class="health-header">
            <span class="health-icon">{{ '&#10003;' if health.external.tmdb else '&#8212;' }}</span>
            <h3>TMDB API</h3>
        </div>
        <div class="health-details">
            <div class="health-row">
                <span>Status</span>
                <span class="status-badge {{ 'success' if health.external.tmdb else 'neutral' }}">
                    {{ 'Configured' if health.external.tmdb else 'Not Configured' }}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="section-header">
    <h2>Quick Actions</h2>
</div>

<div class="actions-grid">
    <form action="/admin/refresh" method="post" class="action-card">
        <h4>Force Refresh</h4>
        <p>Re-fetch all movies from JustWatch</p>
        <input type="hidden" name="limit" value="500">
        <button type="submit" class="btn btn-primary" onclick="return confirm('This will refresh 500 movies. Continue?')">
            Refresh Movies
        </button>
    </form>

    <form action="/admin/incremental-update" method="post" class="action-card">
        <h4>Incremental Update</h4>
        <p>Add only new movies (faster)</p>
        <button type="submit" class="btn btn-secondary">
            Add New Movies
        </button>
    </form>

    <div class="action-card">
        <h4>Clear Cache</h4>
        <p>Invalidate all cached data</p>
        <form action="/admin/clear-cache" method="post">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Clear all cache?')">
                Clear Cache
            </button>
        </form>
    </div>
</div>

<style>
.health-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

.health-card {
    background: var(--bg-surface);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 20px;
    border-left: 4px solid var(--text-muted);
}

.health-card.healthy {
    border-left-color: var(--success);
}

.health-card.unhealthy {
    border-left-color: var(--danger);
}

.health-card.neutral {
    border-left-color: var(--secondary);
}

.health-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.health-icon {
    font-size: 1.5rem;
    width: 30px;
}

.health-card.healthy .health-icon {
    color: var(--success);
}

.health-card.unhealthy .health-icon {
    color: var(--danger);
}

.health-card.neutral .health-icon {
    color: var(--secondary);
}

.health-header h3 {
    font-size: 1rem;
    font-weight: 600;
}

.health-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.health-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
}

.health-row span:first-child {
    color: var(--text-muted);
}

.status-badge {
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-badge.success {
    background: rgba(39, 174, 96, 0.2);
    color: var(--success);
}

.status-badge.error {
    background: rgba(231, 76, 60, 0.2);
    color: var(--danger);
}

.status-badge.warning {
    background: rgba(255, 165, 2, 0.2);
    color: var(--secondary);
}

.status-badge.neutral {
    background: rgba(139, 139, 154, 0.2);
    color: var(--text-muted);
}

.section-header {
    margin: 30px 0 20px;
}

.section-header h2 {
    font-size: 1.2rem;
    font-weight: 600;
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}

.action-card {
    background: var(--bg-surface);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 20px;
}

.action-card h4 {
    margin-bottom: 8px;
}

.action-card p {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 15px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-family: inherit;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    filter: brightness(1.1);
}

.btn-secondary {
    background: var(--bg-elevated);
    color: var(--text);
    border: 1px solid rgba(255,255,255,0.2);
}

.btn-secondary:hover {
    border-color: var(--primary);
}

.btn-danger {
    background: transparent;
    color: var(--danger);
    border: 1px solid var(--danger);
}

.btn-danger:hover {
    background: var(--danger);
    color: white;
}

@media (max-width: 1024px) {
    .health-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .health-grid,
    .actions-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
