{% extends "admin/base.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="page-header flex-between">
    <div>
        <h1>Movies</h1>
        <p>{{ total_movies }} movies in database</p>
    </div>
    <form action="/admin/refresh" method="post" style="display: flex; gap: 10px; align-items: center;">
        <select name="limit" class="form-control" style="width: auto;">
            <option value="200">200 movies</option>
            <option value="500" selected>500 movies</option>
            <option value="1000">1000 movies</option>
        </select>
        <button type="submit" class="btn btn-primary" onclick="return confirm('This will fetch fresh data from APIs. Continue?')">
            Refresh from API
        </button>
    </form>
</div>

{% if request.query_params.get('refreshed') %}
<div class="alert alert-success">Movies refreshed successfully from API!</div>
{% endif %}

{% if request.query_params.get('bulk_added') %}
<div class="alert alert-success">{{ request.query_params.get('bulk_added') }} movies added to list!</div>
{% endif %}

{% if request.query_params.get('bulk_deleted') %}
<div class="alert alert-success">{{ request.query_params.get('bulk_deleted') }} movies deleted!</div>
{% endif %}

<!-- Bulk Actions Toolbar -->
<div class="bulk-toolbar" id="bulkToolbar" style="display: none;">
    <div class="bulk-info">
        <span id="selectedCount">0</span> movies selected
    </div>
    <div class="bulk-actions">
        {% if curated_lists %}
        <select id="bulkListSelect" class="form-control" style="width: auto;">
            <option value="">Add to list...</option>
            {% for list in curated_lists %}
            <option value="{{ list.slug }}">{{ list.label }}</option>
            {% endfor %}
        </select>
        <button type="button" class="btn btn-secondary btn-sm" onclick="bulkAddToList()">Add Selected</button>
        {% endif %}
        <button type="button" class="btn btn-danger btn-sm" onclick="bulkDelete()">Delete Selected</button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="clearSelection()">Clear Selection</button>
    </div>
</div>

<div class="card">
    <form action="/admin/dashboard" method="get" class="search-box">
        <input type="text" name="search" class="form-control" placeholder="Search movies..." value="{{ search }}">
        <button type="submit" class="btn btn-secondary">Search</button>
        {% if search %}
        <a href="/admin/dashboard" class="btn btn-secondary">Clear</a>
        {% endif %}
    </form>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                        </label>
                    </th>
                    <th>Movie</th>
                    <th>Year</th>
                    <th>Rating</th>
                    <th>Genres</th>
                    <th>Services</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for movie in movies %}
                <tr data-movie-slug="{{ movie.slug }}">
                    <td>
                        <label class="checkbox-label">
                            <input type="checkbox" class="movie-checkbox" value="{{ movie.slug }}" onchange="updateSelection()">
                        </label>
                    </td>
                    <td>
                        <div class="movie-title-cell">
                            <img src="{{ movie.poster_url or '/static/placeholder.png' }}"
                                 alt="{{ movie.title }}"
                                 class="movie-poster-sm"
                                 onerror="this.src='/static/placeholder.png'">
                            <div>
                                <strong>{{ movie.title }}</strong>
                            </div>
                        </div>
                    </td>
                    <td>{{ movie.year or '-' }}</td>
                    <td>{{ '%.1f' % movie.rating if movie.rating else '-' }}</td>
                    <td>{{ movie.genres[:3] | join(', ') }}{{ '...' if movie.genres | length > 3 else '' }}</td>
                    <td>{{ movie.streaming_services[:2] | join(', ') }}{{ '...' if movie.streaming_services | length > 2 else '' }}</td>
                    <td>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <a href="/admin/movie/{{ movie.slug }}" class="btn btn-secondary btn-sm">Edit</a>
                            <a href="/movie/{{ movie.slug }}" target="_blank" class="btn btn-secondary btn-sm">View</a>
                            {% if curated_lists %}
                            <select class="form-control" style="width: auto; padding: 6px 10px; font-size: 0.8rem;"
                                    onchange="addToList(this, '{{ movie.slug }}')">
                                <option value="">Add to list...</option>
                                {% for list in curated_lists %}
                                <option value="{{ list.slug }}">{{ list.label }}</option>
                                {% endfor %}
                            </select>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        No movies found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if total_pages > 1 and not search %}
    <nav class="pagination">
        {% if page > 1 %}
        <a href="/admin/dashboard?page={{ page - 1 }}">&laquo; Prev</a>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <span class="current">{{ p }}</span>
            {% elif p <= 3 or p > total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <a href="/admin/dashboard?page={{ p }}">{{ p }}</a>
            {% elif p == 4 and page > 5 %}
            <span>...</span>
            {% elif p == total_pages - 2 and page < total_pages - 4 %}
            <span>...</span>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <a href="/admin/dashboard?page={{ page + 1 }}">Next &raquo;</a>
        {% endif %}
    </nav>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Single movie add to list
async function addToList(select, movieSlug) {
    const listSlug = select.value;
    if (!listSlug) return;

    const formData = new FormData();
    formData.append('movie_slug', movieSlug);

    try {
        const response = await fetch(`/admin/lists/${listSlug}/add-movie`, {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.success) {
            alert('Movie added to list!');
        } else {
            alert('Failed to add movie: ' + (result.error || 'Unknown error'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }

    select.value = '';
}

// Bulk operations
function getSelectedMovies() {
    const checkboxes = document.querySelectorAll('.movie-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function updateSelection() {
    const selected = getSelectedMovies();
    const toolbar = document.getElementById('bulkToolbar');
    const countSpan = document.getElementById('selectedCount');
    const selectAll = document.getElementById('selectAll');
    const allCheckboxes = document.querySelectorAll('.movie-checkbox');

    countSpan.textContent = selected.length;
    toolbar.style.display = selected.length > 0 ? 'flex' : 'none';

    // Update "select all" checkbox state
    if (allCheckboxes.length > 0) {
        selectAll.checked = selected.length === allCheckboxes.length;
        selectAll.indeterminate = selected.length > 0 && selected.length < allCheckboxes.length;
    }
}

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.movie-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSelection();
}

function clearSelection() {
    document.querySelectorAll('.movie-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateSelection();
}

async function bulkAddToList() {
    const selected = getSelectedMovies();
    const listSlug = document.getElementById('bulkListSelect').value;

    if (!listSlug) {
        alert('Please select a list');
        return;
    }

    if (selected.length === 0) {
        alert('No movies selected');
        return;
    }

    if (!confirm(`Add ${selected.length} movies to the selected list?`)) {
        return;
    }

    try {
        const response = await fetch('/admin/bulk/add-to-list', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                movie_slugs: selected,
                list_slug: listSlug
            })
        });

        const result = await response.json();
        if (result.success) {
            window.location.href = `/admin/dashboard?bulk_added=${result.added_count}`;
        } else {
            alert('Failed: ' + (result.error || 'Unknown error'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function bulkDelete() {
    const selected = getSelectedMovies();

    if (selected.length === 0) {
        alert('No movies selected');
        return;
    }

    if (!confirm(`Are you sure you want to delete ${selected.length} movies? This cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch('/admin/bulk/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({movie_slugs: selected})
        });

        const result = await response.json();
        if (result.success) {
            window.location.href = `/admin/dashboard?bulk_deleted=${result.deleted_count}`;
        } else {
            alert('Failed: ' + (result.error || 'Unknown error'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}
</script>

<style>
.bulk-toolbar {
    background: var(--bg-surface);
    border: 1px solid var(--primary);
    border-radius: 8px;
    padding: 12px 20px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
}

.bulk-info {
    font-weight: 600;
    color: var(--primary);
}

.bulk-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.movie-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

tr[data-movie-slug]:hover {
    background: rgba(255,255,255,0.03);
}
</style>
{% endblock %}
